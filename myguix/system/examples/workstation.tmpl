;; -*- mode: scheme; -*-
;; This is an operating system configuration template
;; for a high-performance workstation with comprehensive
;; development tools, using myguix for enhanced hardware support.

(use-modules (gnu)
             (gnu system nss)
             (gnu services desktop)
             (gnu services databases)
             (gnu services networking)
             (gnu services ssh)
             (gnu services docker)
             (gnu services virtualization)
             (gnu services linux)
             (gnu services cups)
             (gnu packages gnome)
             (myguix packages base)
             (myguix packages linux)
             (myguix system linux-initrd)
             (srfi srfi-1))

(operating-system
  (host-name "workstation")
  (timezone "Asia/Kolkata")
  (locale "en_US.utf8")

  ;; Full Linux kernel with firmware and nvidia support
  (kernel linux)
  (kernel-arguments (append '("modprobe.blacklist=nouveau"
                              "nvidia_drm.modeset=1"
                              "nvidia_drm.fbdev=1")
                            %default-kernel-arguments))
  (firmware (list linux-firmware sof-firmware))
  (initrd microcode-initrd)

  ;; Enhanced keyboard layout for development
  (keyboard-layout (keyboard-layout "us"
                                    "altgr-intl"
                                    #:model "thinkpad"
                                    #:options '("ctrl:nocaps"
                                                "altwin:swap_alt_win")))

  ;; UEFI boot with encrypted root
  (bootloader (bootloader-configuration
                (bootloader grub-efi-bootloader)
                (targets '("/boot/efi"))
                (keyboard-layout keyboard-layout)))

  ;; Encrypted root partition
  (mapped-devices
   (list (mapped-device
          (source (uuid "12345678-1234-1234-1234-123456789abc"))
          (target "crypt-root")
          (type luks-device-mapping))))

  (file-systems (append
                 (list (file-system
                         (device (file-system-label "my-root"))
                         (mount-point "/")
                         (type "btrfs")
                         (dependencies mapped-devices))
                       (file-system
                         (device (uuid "1234-ABCD" 'fat32))
                         (mount-point "/boot/efi")
                         (type "vfat")))
                 %base-file-systems))

  ;; Swap configuration
  (swap-devices (list (swap-space
                       (target "/swapfile"))))

  ;; Developer user account
  (users (cons (user-account
                (name "dev")
                (comment "Developer")
                (group "users")
                (supplementary-groups '("wheel" "netdev" "kvm" "tty"
                                        "libvirt" "input" "docker"
                                        "lp" "audio" "video")))
               %base-user-accounts))

  ;; Comprehensive package selection for workstation
  (packages (append
             ;; Core System
             %core-minimal
             %core-extended
             %shell-modern
             %terminal-essentials
             %text-editors
             %security-essentials
             
             ;; Development - Core
             %build-essentials
             %compiler-toolchains
             %version-control
             %compression-tools
             
             ;; Development - Languages
             %c-cpp-development
             %python-development
             %rust-development
             
             ;; Language Servers
             %language-servers-core
             
             ;; Development Support
             %documentation-tools
             
             ;; Networking
             %network-core
             %network-diagnostics
             
             ;; File Management
             %filesystem-core
             %filesystem-advanced
             %backup-tools
             %download-tools
             
             ;; Desktop
             %desktop-browsers
             %desktop-core
             
             ;; Fonts
             %fonts-essential
             %fonts-programming
             
             %base-packages))

  ;; Workstation services
  (services
   (append
    (list
     ;; Desktop environment
     (service gnome-desktop-service-type)
     
     ;; SSH for remote access
     (service openssh-service-type
              (openssh-configuration
               (permit-root-login #f)
               (password-authentication? #t)))
     
     ;; Printing
     (service cups-service-type
              (cups-configuration
               (web-interface? #t)))
     
     ;; Databases
     (service postgresql-service-type)
     (service redis-service-type)
     
     ;; Virtualization
     (service libvirt-service-type)
     (service docker-service-type)
     
     ;; System optimization
     (service earlyoom-service-type)
     (service zram-device-service-type
              (zram-device-configuration
               (size "8G")
               (compression-algorithm 'zstd)))
     
     ;; SSD optimization
     (service fstrim-service-type))
    
    ;; Include standard desktop services
    %desktop-services))

  ;; Allow resolution of '.local' host names with mDNS.
  (name-service-switch %mdns-host-lookup-nss))